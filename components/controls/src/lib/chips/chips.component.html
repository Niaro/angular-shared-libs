<mat-form-field [appearance]="$any(appearance)" [color]="color" [floatLabel]="floatLabel">
	<mat-label *ngIf="label">
		{{ label }}
		<span *ngIf="required" class="mat-placeholder-required mat-form-field-required-marker">
			*
		</span>
	</mat-label>

	<mat-chip-list #chipList [formControl]="externalControl!">
		<mat-chip
			*ngFor="let v of value"
			#chip
			@fade
			[color]="color"
			[attr.title]="v.description"
			[removable]="true"
			(removed)="remove(v)"
		>
			<ng-template
				*ngIf="portal; else defaultTpl"
				[ngTemplateOutlet]="portal!.templateRef"
				[ngTemplateOutletContext]="{ $implicit: v }"
			>
			</ng-template>

			<ng-template #defaultTpl>
				{{ getDisplayName(v) }}
			</ng-template>
			<mat-icon matChipRemove>cancel</mat-icon>
		</mat-chip>

		<input
			#input
			[formControl]="internalControl"
			[attr.name]="name"
			[placeholder]="placeholder"
			[required]="!!required"
			[matAutocomplete]="autocomplete"
			[matChipInputFor]="chipList"
			[matChipInputSeparatorKeyCodes]="separatorKeysCodes"
			[matChipInputAddOnBlur]="true"
			(matChipInputTokenEnd)="add($event)"
		/>
	</mat-chip-list>

	<mat-autocomplete #autocomplete="matAutocomplete" (optionSelected)="selected($event)">
		<mat-option
			*ngFor="let v of filtered"
			class="chip-autocomplete-option"
			[class.has-description]="v.description"
			[value]="v"
		>
			<div>
				<ng-template
					*ngIf="portal; else defaultTpl"
					[ngTemplateOutlet]="portal!.templateRef"
					[ngTemplateOutletContext]="{ $implicit: v, isMatOption: true }"
				>
				</ng-template>

				<ng-template #defaultTpl>
					{{ getDisplayName(v) }}
				</ng-template>
			</div>
			<div *ngIf="v.description" class="description mat-caption">
				{{ v.description }}
			</div>
		</mat-option>
	</mat-autocomplete>

	<mat-hint *ngIf="hint">{{ hint }}</mat-hint>

	<mat-error bpFieldError [bpFieldErrorSuppress]="hideErrorText"> </mat-error>
</mat-form-field>
